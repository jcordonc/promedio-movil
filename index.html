<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Molinos 361/362 + MA global + Set/Límites</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7fb; }
    header { padding: 18px 20px; background: white; border-bottom: 1px solid #e6e8ef; }
    h1 { margin: 0; font-size: 18px; }
    main { display: grid; grid-template-columns: 460px 1fr; gap: 14px; padding: 14px; }
    .card { background: white; border: 1px solid #e6e8ef; border-radius: 14px; padding: 14px; box-shadow: 0 1px 6px rgba(0,0,0,.04); }
    label { font-size: 12px; color:#40465a; display:block; margin-bottom: 6px; }
    input, textarea, select, button {
      width: 100%; box-sizing: border-box; border-radius: 10px;
      border: 1px solid #d8dcec; padding: 10px; font-size: 14px;
    }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btns { display:flex; gap:10px; margin-top:10px; }
    button { cursor:pointer; border: 1px solid #d8dcec; background:#111827; color:white; }
    button.secondary { background:white; color:#111827; }
    button.danger { background:#b42318; border-color:#b42318; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom: 1px solid #eef0f6; padding: 8px 6px; font-size: 13px; text-align:left; }
    th { color:#40465a; font-weight: 600; }
    .muted { color:#6b7280; font-size: 12px; }
    canvas { width: 100%; height: 360px; }
    .grid2 { display:grid; grid-template-columns: 1fr; gap: 14px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #e6e8ef; background:#fafbff; color:#40465a; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } canvas { height: 340px; } }
  </style>
</head>
<body>
<header>
  <h1>Molinos 361 / 362 — MA global + Setpoint/LCL/UCL</h1>
  <div class="muted">MA global se calcula con todos los datos (sin separar). Setpoint y límites se dibujan en ambas gráficas.</div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 10px 0; font-size:15px;">Agregar dato</h2>

    <div class="row">
      <div>
        <label for="dtInput">Fecha y hora</label>
        <input id="dtInput" type="datetime-local" />
        <div class="muted">Si lo dejas vacío, se usará la fecha/hora actual.</div>
      </div>
      <div>
        <label for="molinoInput">Molino</label>
        <select id="molinoInput">
          <option value="361">361</option>
          <option value="362">362</option>
        </select>
      </div>
    </div>

    <label for="valueInput" style="margin-top:10px;">Valor</label>
    <input id="valueInput" type="number" step="any" placeholder="Ej. 12.5" />

    <div class="btns">
      <button id="addBtn">Agregar</button>
      <button class="secondary" id="clearBtn">Limpiar todo</button>
    </div>

    <hr style="border:none;border-top:1px solid #eef0f6;margin:14px 0;">

    <label for="bulkInput">Pegar lista (una por línea)</label>
    <textarea id="bulkInput" placeholder="Ejemplos:
2026-01-14T08:15,361,12.5
2026-01-14 08:15, 362, 13.1
361, 12.0
362, 11.7
12.3   (si no pones molino, asume 361)"></textarea>

    <div class="btns">
      <button class="secondary" id="importBtn">Importar</button>
      <button class="secondary" id="exportBtn">Exportar CSV</button>
    </div>

    <hr style="border:none;border-top:1px solid #eef0f6;margin:14px 0;">

    <h2 style="margin:0 0 10px 0; font-size:15px;">Promedio móvil (global)</h2>
    <label for="windowInput">Ventana (N)</label>
    <input id="windowInput" type="number" min="1" value="7" />

    <hr style="border:none;border-top:1px solid #eef0f6;margin:14px 0;">

    <h2 style="margin:0 0 10px 0; font-size:15px;">Setpoint y límites</h2>

    <label for="controlMode">Modo</label>
    <select id="controlMode">
      <option value="tolerance">Setpoint ± tolerancia</option>
      <option value="direct">LCL/UCL directos</option>
    </select>

    <div class="row3" style="margin-top:10px;">
      <div>
        <label for="setpointInput">Setpoint</label>
        <input id="setpointInput" type="number" step="any" placeholder="Ej. 12.0" />
      </div>

      <div id="tolWrap">
        <label for="toleranceInput">Tolerancia (±)</label>
        <input id="toleranceInput" type="number" step="any" placeholder="Ej. 1.5" />
      </div>

      <div id="uclWrap" style="display:none;">
        <label for="uclInput">UCL</label>
        <input id="uclInput" type="number" step="any" placeholder="Ej. 13.5" />
      </div>
    </div>

    <div class="row3" style="margin-top:10px;">
      <div id="lclWrap" style="display:none;">
        <label for="lclInput">LCL</label>
        <input id="lclInput" type="number" step="any" placeholder="Ej. 10.5" />
      </div>

      <div>
        <label for="showControl">Mostrar líneas</label>
        <select id="showControl">
          <option value="on">Sí</option>
          <option value="off">No</option>
        </select>
      </div>

      <div>
        <label>Guardado</label>
        <span class="pill" id="persistInfo">Activo</span>
      </div>
    </div>

    <div class="btns">
      <button class="secondary" id="saveSettingsBtn">Guardar ajustes</button>
      <button class="danger" id="deleteLastBtn">Eliminar último</button>
    </div>

    <h3 style="margin:14px 0 8px 0; font-size:14px;">Tabla</h3>
    <div style="max-height:260px; overflow:auto; border:1px solid #eef0f6; border-radius:10px;">
      <table>
        <thead>
          <tr><th>#</th><th>FechaHora</th><th>Molino</th><th>Valor</th><th>MA(global)</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 10px 0; font-size:15px;">Gráficas</h2>

    <div class="grid2">
      <div class="card" style="box-shadow:none;">
        <div class="muted" style="margin-bottom:6px;">Molino 361 (negro) + MA global (azul) + Set/Límites</div>
        <canvas id="chart361" width="1200" height="500"></canvas>
      </div>

      <div class="card" style="box-shadow:none;">
        <div class="muted" style="margin-bottom:6px;">Molino 362 (negro) + MA global (azul) + Set/Límites</div>
        <canvas id="chart362" width="1200" height="500"></canvas>
      </div>
    </div>

    <div class="muted" id="summary" style="margin-top:10px;"></div>
  </section>
</main>

<script>
  const STORAGE_KEY = "pm_molinos_state_v3";

  const state = {
    points: [], // { id, dtISO, dtMs, molino, value }
    settings: {
      windowSize: 7,
      controlMode: "tolerance", // tolerance | direct
      setpoint: null,
      tolerance: null,
      lcl: null,
      ucl: null,
      showControl: "on"
    }
  };

  const els = {
    dtInput: document.getElementById("dtInput"),
    molinoInput: document.getElementById("molinoInput"),
    valueInput: document.getElementById("valueInput"),
    addBtn: document.getElementById("addBtn"),
    clearBtn: document.getElementById("clearBtn"),
    bulkInput: document.getElementById("bulkInput"),
    importBtn: document.getElementById("importBtn"),
    exportBtn: document.getElementById("exportBtn"),
    windowInput: document.getElementById("windowInput"),
    saveSettingsBtn: document.getElementById("saveSettingsBtn"),
    deleteLastBtn: document.getElementById("deleteLastBtn"),
    persistInfo: document.getElementById("persistInfo"),
    tableBody: document.getElementById("tableBody"),
    chart361: document.getElementById("chart361"),
    chart362: document.getElementById("chart362"),
    summary: document.getElementById("summary"),
    controlMode: document.getElementById("controlMode"),
    setpointInput: document.getElementById("setpointInput"),
    toleranceInput: document.getElementById("toleranceInput"),
    lclInput: document.getElementById("lclInput"),
    uclInput: document.getElementById("uclInput"),
    showControl: document.getElementById("showControl"),
    tolWrap: document.getElementById("tolWrap"),
    lclWrap: document.getElementById("lclWrap"),
    uclWrap: document.getElementById("uclWrap"),
  };

  function safeNumber(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function normalizeMolino(m) {
    const s = String(m || "").trim();
    if (s === "361" || s === "362") return s;
    return null;
  }

  function nowLocalDatetimeISO() {
    const d = new Date();
    const pad = (x) => String(x).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function parseDatetimeToISO(dtStr) {
    if (!dtStr) return null;
    const cleaned = dtStr.trim().replace(" ", "T");
    const d = new Date(cleaned);
    if (Number.isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  function formatLocal(dtISO) {
    const d = new Date(dtISO);
    const pad = (x) => String(x).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function saveToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      els.persistInfo.textContent = "Guardado";
    } catch (e) {
      els.persistInfo.textContent = "No se pudo guardar";
      console.warn(e);
    }
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      const parsed = JSON.parse(raw);
      if (parsed && Array.isArray(parsed.points) && parsed.settings) {
        state.points = parsed.points
          .map(p => ({
            id: String(p.id),
            dtISO: String(p.dtISO),
            dtMs: Number(p.dtMs),
            molino: String(p.molino),
            value: Number(p.value),
          }))
          .filter(p => Number.isFinite(p.value) && Number.isFinite(p.dtMs) && (p.molino === "361" || p.molino === "362"));
        state.settings = { ...state.settings, ...parsed.settings };
        return true;
      }
    } catch (e) {
      console.warn("Error leyendo storage:", e);
    }
    return false;
  }

  function addPoint(dtLocalStr, molinoStr, value) {
    const molino = normalizeMolino(molinoStr) || "361";
    const dtISO = parseDatetimeToISO(dtLocalStr) || new Date().toISOString();
    const dtMs = new Date(dtISO).getTime();
    const id = crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    state.points.push({ id, dtISO, dtMs, molino, value });
    saveToStorage();
    render();
  }

  function movingAverageByIndex(sortedPoints, windowSize) {
    const ma = new Map();
    const vals = sortedPoints.map(p => p.value);
    let sum = 0;
    for (let i = 0; i < vals.length; i++) {
      sum += vals[i];
      if (i >= windowSize) sum -= vals[i - windowSize];
      if (i >= windowSize - 1) ma.set(sortedPoints[i].id, sum / windowSize);
      else ma.set(sortedPoints[i].id, null);
    }
    return ma;
  }

  function parseBulk(text) {
    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    const parsed = [];

    for (const line of lines) {
      const parts = line.split(/[,;|\t]+/).map(s => s.trim()).filter(Boolean);

      let dt = "";
      let molino = "";
      let value = null;

      if (parts.length >= 3) {
        dt = parts[0];
        molino = parts[1];
        value = safeNumber(parts[2]);
      } else if (parts.length === 2) {
        const m1 = normalizeMolino(parts[0]);
        const m2 = normalizeMolino(parts[1]);
        if (m1) { molino = parts[0]; value = safeNumber(parts[1]); }
        else if (m2) { molino = parts[1]; value = safeNumber(parts[0]); }
        else { dt = parts[0]; value = safeNumber(parts[1]); }
      } else {
        const tryNumber = safeNumber(parts[0]);
        if (tryNumber !== null) { value = tryNumber; molino = "361"; }
        else {
          const p2 = line.split(/\s+/).map(s => s.trim()).filter(Boolean);
          if (p2.length >= 3) {
            const last = safeNumber(p2[p2.length - 1]);
            if (last !== null) {
              value = last;
              const mm = p2.find(t => normalizeMolino(t));
              molino = mm || "361";
              const dtTokens = p2.filter(t => t !== molino && t !== String(value));
              dt = dtTokens.slice(0, 2).join(" ");
            }
          }
        }
      }

      if (value === null) continue;
      if (!molino) molino = "361";
      parsed.push({ dt, molino, value });
    }

    return parsed;
  }

  function computeLimits() {
    if ((state.settings.showControl || "on") !== "on") return { setpoint: null, lcl: null, ucl: null };

    const sp = safeNumber(state.settings.setpoint);
    if (sp === null) return { setpoint: null, lcl: null, ucl: null };

    const mode = state.settings.controlMode || "tolerance";
    if (mode === "tolerance") {
      const tol = safeNumber(state.settings.tolerance);
      if (tol === null) return { setpoint: sp, lcl: null, ucl: null };
      return { setpoint: sp, lcl: sp - tol, ucl: sp + tol };
    }

    const lcl = safeNumber(state.settings.lcl);
    const ucl = safeNumber(state.settings.ucl);
    return { setpoint: sp, lcl: lcl, ucl: ucl };
  }

  function exportCSV() {
    const windowSize = Math.max(1, parseInt(els.windowInput.value || "1", 10));
    const sorted = [...state.points].sort((a,b) => a.dtMs - b.dtMs);
    const maMap = movingAverageByIndex(sorted, windowSize);
    const limits = computeLimits();

    const rows = [["id","datetime_iso","datetime_local","molino","value","ma_global","setpoint","lcl","ucl"]];
    for (const p of sorted) {
      const ma = maMap.get(p.id);
      rows.push([
        p.id,
        p.dtISO,
        formatLocal(p.dtISO),
        p.molino,
        String(p.value),
        ma === null ? "" : String(ma),
        limits.setpoint ?? "",
        limits.lcl ?? "",
        limits.ucl ?? ""
      ]);
    }

    const csv = rows.map(r => r.map(cell => {
      const s = String(cell ?? "");
      return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
    }).join(",")).join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "molinos_ma_set_limites.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function renderTable(sorted, maMap) {
    els.tableBody.innerHTML = "";
    for (let i = 0; i < sorted.length; i++) {
      const p = sorted[i];
      const ma = maMap.get(p.id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${formatLocal(p.dtISO)}</td>
        <td>${p.molino}</td>
        <td>${p.value}</td>
        <td>${ma === null ? "" : ma.toFixed(4)}</td>
      `;
      els.tableBody.appendChild(tr);
    }
  }

  function updateControlModeVisibility() {
    const mode = els.controlMode.value;
    if (mode === "tolerance") {
      els.tolWrap.style.display = "block";
      els.lclWrap.style.display = "none";
      els.uclWrap.style.display = "none";
    } else {
      els.tolWrap.style.display = "none";
      els.lclWrap.style.display = "block";
      els.uclWrap.style.display = "block";
    }
  }

  function drawHorizontalLine(ctx, cssW, padding, yPos, label, dash) {
    ctx.save();
    ctx.setLineDash(dash || [6,4]);
    ctx.beginPath();
    ctx.moveTo(padding.left, yPos);
    ctx.lineTo(cssW - padding.right, yPos);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillText(label, padding.left + 6, yPos - 6);
    ctx.restore();
  }

  function drawChart(canvas, seriesPoints, globalSorted, maMap, titleMolino) {
    const ctx = canvas.getContext("2d");

    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 1200;
    const cssH = 360;
    canvas.style.height = cssH + "px";
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    ctx.clearRect(0, 0, cssW, cssH);

    const padding = { left: 60, right: 20, top: 20, bottom: 55 };
    const w = cssW - padding.left - padding.right;
    const h = cssH - padding.top - padding.bottom;

    // Eje X global
    const indexById = new Map();
    for (let i = 0; i < globalSorted.length; i++) indexById.set(globalSorted[i].id, i);

    const N = globalSorted.length;
    const x = (i) => padding.left + (N === 1 ? w/2 : (i / (N - 1)) * w);

    const molinoSeries = new Array(N).fill(null);
    for (const p of seriesPoints) {
      const idx = indexById.get(p.id);
      if (idx !== undefined) molinoSeries[idx] = p.value;
    }

    const maSeries = globalSorted.map(p => maMap.get(p.id));
    const limits = computeLimits();

    const extraY = [];
    if (limits.setpoint !== null) extraY.push(limits.setpoint);
    if (limits.lcl !== null) extraY.push(limits.lcl);
    if (limits.ucl !== null) extraY.push(limits.ucl);

    const allY = []
      .concat(molinoSeries.filter(v => v !== null))
      .concat(maSeries.filter(v => v !== null))
      .concat(extraY);

    if (allY.length === 0) return;

    const minY = Math.min(...allY);
    const maxY = Math.max(...allY);
    const span = (maxY - minY) || 1;
    const y = (v) => padding.top + (1 - ((v - minY) / span)) * h;

    // axes
    ctx.strokeStyle = "#cfd6ea";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top);
    ctx.lineTo(padding.left, padding.top + h);
    ctx.lineTo(padding.left + w, padding.top + h);
    ctx.stroke();

    // grid
    ctx.strokeStyle = "#eef0f6";
    for (let i = 1; i <= 4; i++) {
      const yy = padding.top + (i/5) * h;
      ctx.beginPath();
      ctx.moveTo(padding.left, yy);
      ctx.lineTo(padding.left + w, yy);
      ctx.stroke();
    }

    // Y labels
    ctx.fillStyle = "#40465a";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(minY.toFixed(2), 6, padding.top + h);
    ctx.fillText(maxY.toFixed(2), 6, padding.top + 12);

    // X ticks
    const tickCount = Math.min(6, N);
    for (let t = 0; t < tickCount; t++) {
      const idx = tickCount === 1 ? 0 : Math.round((t/(tickCount-1)) * (N - 1));
      const lx = x(idx);
      const lbl = formatLocal(globalSorted[idx].dtISO);
      ctx.fillText(lbl, Math.max(0, lx - 32), padding.top + h + 28);
    }

    function drawLine(series, stroke, width = 2, dashed = false) {
      ctx.strokeStyle = stroke;
      ctx.lineWidth = width;
      ctx.setLineDash(dashed ? [6,4] : []);
      ctx.beginPath();
      let started = false;
      for (let i = 0; i < series.length; i++) {
        const v = series[i];
        if (v === null || !Number.isFinite(v)) continue;
        const xx = x(i);
        const yy = y(v);
        if (!started) { ctx.moveTo(xx, yy); started = true; }
        else ctx.lineTo(xx, yy);
      }
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // series
    drawLine(molinoSeries, "#111827", 2, false); // dato molino
    drawLine(maSeries, "#2563eb", 3, true);      // MA global

    // control lines
    if (limits.setpoint !== null) {
      ctx.strokeStyle = "#7c3aed";
      ctx.fillStyle = "#7c3aed";
      drawHorizontalLine(ctx, cssW, padding, y(limits.setpoint), `Set: ${limits.setpoint}`, [2,0]);
    }
    if (limits.ucl !== null) {
      ctx.strokeStyle = "#b42318";
      ctx.fillStyle = "#b42318";
      drawHorizontalLine(ctx, cssW, padding, y(limits.ucl), `UCL: ${limits.ucl}`, [8,4]);
    }
    if (limits.lcl !== null) {
      ctx.strokeStyle = "#b42318";
      ctx.fillStyle = "#b42318";
      drawHorizontalLine(ctx, cssW, padding, y(limits.lcl), `LCL: ${limits.lcl}`, [8,4]);
    }

    // título + leyenda
    ctx.fillStyle = "#111827";
    ctx.fillText(`Molino ${titleMolino}`, padding.left + 10, padding.top + 14);
    ctx.fillStyle = "#111827";
    ctx.fillText("Dato", padding.left + 90, padding.top + 14);
    ctx.fillStyle = "#2563eb";
    ctx.fillText("MA global", padding.left + 130, padding.top + 14);
  }

  function render() {
    state.settings.windowSize = Math.max(1, parseInt(els.windowInput.value || "1", 10));

    const globalSorted = [...state.points].sort((a,b) => a.dtMs - b.dtMs);
    const maMap = movingAverageByIndex(globalSorted, state.settings.windowSize);

    const m361 = globalSorted.filter(p => p.molino === "361");
    const m362 = globalSorted.filter(p => p.molino === "362");

    renderTable(globalSorted, maMap);
    drawChart(els.chart361, m361, globalSorted, maMap, "361");
    drawChart(els.chart362, m362, globalSorted, maMap, "362");

    const lastMA = [...globalSorted].reverse().map(p => maMap.get(p.id)).find(v => v !== null);
    const lim = computeLimits();

    els.summary.textContent =
      `Puntos: ${globalSorted.length} | Ventana MA: ${state.settings.windowSize} | Último MA: ${lastMA === undefined ? "N/A" : lastMA.toFixed(4)} | ` +
      `Set: ${lim.setpoint ?? "—"} | LCL: ${lim.lcl ?? "—"} | UCL: ${lim.ucl ?? "—"}`;

    saveToStorage();
  }

  // ===== Eventos =====
  els.addBtn.addEventListener("click", () => {
    const value = safeNumber(els.valueInput.value);
    if (value === null) return alert("Ingresa un valor numérico válido.");
    const dtLocal = els.dtInput.value || nowLocalDatetimeISO();
    const molino = els.molinoInput.value;
    addPoint(dtLocal, molino, value);
    els.valueInput.value = "";
  });

  els.clearBtn.addEventListener("click", () => {
    if (!confirm("¿Borrar TODOS los datos guardados en este navegador?")) return;
    state.points = [];
    saveToStorage();
    render();
  });

  els.importBtn.addEventListener("click", () => {
    const parsed = parseBulk(els.bulkInput.value || "");
    if (parsed.length === 0) return alert("No se detectaron valores válidos.");
    for (const p of parsed) addPoint(p.dt, p.molino, p.value);
    els.bulkInput.value = "";
  });

  els.exportBtn.addEventListener("click", exportCSV);

  els.deleteLastBtn.addEventListener("click", () => {
    state.points.pop();
    saveToStorage();
    render();
  });

  els.controlMode.addEventListener("change", () => {
    updateControlModeVisibility();
  });

  els.saveSettingsBtn.addEventListener("click", () => {
    // leer settings
    state.settings.windowSize = Math.max(1, parseInt(els.windowInput.value || "1", 10));
    state.settings.controlMode = els.controlMode.value;
    state.settings.setpoint = safeNumber(els.setpointInput.value);
    state.settings.tolerance = safeNumber(els.toleranceInput.value);
    state.settings.lcl = safeNumber(els.lclInput.value);
    state.settings.ucl = safeNumber(els.uclInput.value);
    state.settings.showControl = els.showControl.value;

    // validaciones suaves
    if (state.settings.showControl === "on" && state.settings.setpoint === null) {
      alert("Para mostrar set/límites, ingresa un Setpoint válido.");
      return;
    }
    if (state.settings.controlMode === "tolerance" && state.settings.showControl === "on") {
      if (state.settings.tolerance === null) {
        alert("En modo tolerancia, ingresa una tolerancia válida.");
        return;
      }
    }

    saveToStorage();
    render();
  });

  els.windowInput.addEventListener("input", () => {
    state.settings.windowSize = Math.max(1, parseInt(els.windowInput.value || "1", 10));
    saveToStorage();
    render();
  });

  window.addEventListener("resize", () => render());

  // ===== Inicio =====
  function syncSettingsToInputs() {
    els.windowInput.value = String(state.settings.windowSize ?? 7);

    els.controlMode.value = state.settings.controlMode ?? "tolerance";
    els.setpointInput.value = state.settings.setpoint ?? "";
    els.toleranceInput.value = state.settings.tolerance ?? "";
    els.lclInput.value = state.settings.lcl ?? "";
    els.uclInput.value = state.settings.ucl ?? "";
    els.showControl.value = state.settings.showControl ?? "on";
    updateControlModeVisibility();
  }

  const loaded = loadFromStorage();
  syncSettingsToInputs();

  if (!loaded || state.points.length === 0) {
    addPoint("2026-01-14T08:00", "361", 10);
    addPoint("2026-01-14T08:10", "362", 12);
    addPoint("2026-01-14T08:20", "361", 9);
    addPoint("2026-01-14T08:30", "362", 14);
    addPoint("2026-01-14T08:40", "361", 13);
    addPoint("2026-01-14T08:50", "362", 15);

    state.settings.setpoint = 12;
    state.settings.tolerance = 2;
    state.settings.controlMode = "tolerance";
    state.settings.showControl = "on";
    syncSettingsToInputs();
    saveToStorage();
  }

  els.dtInput.value = nowLocalDatetimeISO();
  render();
</script>
</body>
</html>
